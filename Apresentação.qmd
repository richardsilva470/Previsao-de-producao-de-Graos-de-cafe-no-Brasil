---
title: "Previsão dos Estoques de Grãos no Brasil"
author: "Richard Matheus"
format: revealjs
editor: visual
---

```{r, echo=FALSE, warning=FALSE}
## Bibliotecas de séries temporais
library(TSA)
library(forecast)
library(fpp3)
library(readxl)
library(scales)
library(dplyr)
library(tsibble)
library(stringr)
library(lubridate)

tute1 = read_excel("dados.xlsx")


tute1 = transform(tute1, Totais = Totais/1000000 )

serie <- tute1 %>%
  mutate(Semestres = yearmonth(Semestres)) %>%
  as_tsibble(index = Semestres)

```

# Introdução

**Objetivo do estudo**\
Modelar e prever os estoques de grãos de café no Brasil utilizando modelos de suavização exponencial, avaliando seu desempenho preditivo.

**Base de dados**

-   Dados semestrais de estoques de grãos

-   Período analisado: 2007–2025

-   Unidade: milhões de toneladas

# Gráfico da série

```{r, echo=FALSE}
### Plot das series
serie %>%
  pivot_longer(-Semestres) %>%
  ggplot(aes(x = Semestres, y = value, colour = name)) +
  geom_line() +
  facet_grid(name ~ ., scales = "free_y")
```

## **Principais características observadas:**

-   Tendência crescente ao longo do tempo

-   Sazonalidade semestral bem definida

-   Amplitude crescente das oscilações

## Gráficos ACF e PACF

```{r, echo=FALSE}
### ESTUDO PARA A VARIAVEL SALES 

### ACF e PACF das series 
acf_totais = serie %>% 
  ACF(Totais, lag_max = 40) %>% 
  autoplot() + labs(title="ACF da variável Totais")

pacf_totais = serie %>% 
  PACF(Totais, lag_max = 40) %>% 
  autoplot() + labs(title="PACF da variável Totais")

gridExtra::grid.arrange(acf_totais, pacf_totais, ncol=2)
```

-   ACF com decaimento lento

-   PACF com pico significativo no primeiro lag

-   Indica necessidade de modelos com tendência e sazonalidade

## Sazonalidade por ano

```{r, echo=FALSE}


serie %>%
  gg_season(Totais, labels = "both") +
  labs(y = "Toneladas",
       title = "Sazonalidade: Totais")


```

-   Primeiro semestre apresenta valores sistematicamente mais elevados

-   Formato da sazonalidade permanece estável ao longo dos anos

# Subseries plot

```{r, echo=FALSE}
### subgraficos 

serie %>%
  gg_subseries(Totais) +
  labs(
    y = "Quantidade de Toneladas",
    title = "Sazonalidade: Totais"
  )

```

-   Confirma sazonalidade semestral clara

-   Diferença proporcional constante → estrutura multiplicativa

```{r, echo=FALSE}
serie %>%
  model(
    classical_decomposition(Totais, type = "additive")
  ) %>%
  components() %>%
  autoplot() +
  labs(title = "Decomposição classica aditiva do total")

```

```{r, echo=FALSE}
### Decomposição multiplicativa
serie %>%
  model(
    classical_decomposition(Totais, type = "multiplicative")
  ) %>%
  components() %>%
  autoplot() +
  labs(title = "Decomposição classica aditiva do total de vendas")

```

## Conclusão da decomposição

A decomposição multiplicativa é mais adequada, pois a sazonalidade cresce proporcionalmente ao nível da série.

# Treino e Teste

Utilizou-se 70% dos dados para treinamento e 30% para teste, a fim de avaliar o desempenho do modelo nas previsões.

Onde treino foi feito no periodo de **julho de 2007 à julho de 2019** e teste foi feito do periodo de **janeiro de 2020** em diante.

```{r, warning=FALSE}
#### Forecast ---- 

# Definindo a base de dados em treinamento e teste
train <- serie %>%
  filter_index("2007 jul" ~ "2019 jul")


test <- serie %>%
  filter_index("2020 jan" ~ .)


```

```{r, warning=FALSE}
sales_fit <- train %>%
  model(
    # SES (Suavização Exponencial Simples)
    SES = ETS(Totais ~ error("A") + trend("N") + season("N")),
    
    # Holt aditivo
    HoltA = ETS(Totais ~ error("A") + trend("A") + season("N")),
    
    # Holt multiplicativo
    HoltM = ETS(Totais ~ error("M") + trend("A") + season("N")),
    
    # Holt-Winters aditivo
    HW_Add = ETS(Totais ~ error("A") + trend("A") + season("A")),
    
    # Holt-Winters multiplicativo
    HW_Mult = ETS(Totais ~ error("M") + trend("A") + season("M"))
  )

# GERANDO UMA PREVISAO h = 4 passos 
sales_fc <- sales_fit %>% forecast(h = 4)
```

# Teste do modelos

```{r, echo=FALSE}
# Grafico da serie com as previsoes 
sales_fc %>%
  autoplot(train, level = NULL) +
  autolayer(
    test,
    colour = "red"
  ) +
  labs(
    y = "Toneladas",
    title = "Previsão de toneladas de 2020 à 2021"
  ) +
  guides(colour = guide_legend(title = "Forecast"))

```

# Avaliação dos Modelos

```{r, echo=FALSE}
### Medidas de avaliacao 
accuracy(sales_fc, test)
```

```{r, echo=FALSE}
# Estimando o modelo de suavizacao
sales_fit <- serie %>%
  model(
    ETS5 = ETS( Totais ~ error("M") + trend("A") + season("M")) 
  )

```

```{r, echo=FALSE}
# GERANDO UMA PREVISAO h = 4 passos 
sales_fc <- sales_fit %>% forecast(h = 4)
```

Aqui podemos ver que o modelo ***HW_Mult*** se destaca pela seus valores de RMSE = 4.04, MAE = 3.18, MAPE = 7.7 e ME = 1.46 abaixo dos demais

# Modelo Final e Previsão

```{r, echo=FALSE}
# Grafico da serie com as previsoes 
sales_fc %>%
  autoplot(serie, level = NULL) +
  autolayer(
    test,
    colour = "black"
  ) +
  labs(
    y = "Toneladas",
    title = "Previsão de toneladas para os 4 próximos semestres"
  ) +
  guides(colour = guide_legend(title = "Forecast"))

```

Utilizando o modelo ***HW_Mult*** foi feita a previsão de 4 semestres a frente.

## Diagnóstico dos Resíduos

```{r, echo=FALSE}
### analise de residuos 
sales_fit %>% gg_tsresiduals()
```

-   Resíduos aproximadamente aleatórios

-   Ausência de padrões sistemáticos

-   Indica bom ajuste do modelo

# Conclusão

-   Série apresenta tendência crescente e sazonalidade semestral multiplicativa

-   Holt-Winters multiplicativo foi o modelo mais adequado

-   Modelo apresenta bom desempenho fora da amostra
